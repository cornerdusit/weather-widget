<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC/USDT Price + Weather + AQI + Cat GIF</title>
  <style>
    html, body {
      margin: 0; height: 100%;
      background-color: #000;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      color: #ff9100;
      font-family: 'Monospace', monospace;
      position: relative; /* For layering */
    }
    #catGif {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      height: 300px;
      overflow: hidden;
      background-color: #eee;
      opacity: 0.5;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
    }
    #price { 
      font-size: 140pt; line-height: 1; white-space: nowrap; text-align: center; font-weight: 800; 
      position: relative;
      z-index: 2;
      transition: transform 0.5s ease;
    }
    .hidden { display: none; }
    #toggle-price-btn { position: absolute; top: 20px; right: 20px; font-size: 20pt; background: none; border: none; color: #00ff00; cursor: pointer; z-index: 3; }
    hr { width: 80%; border: none; border-top: 1px solid #ff9100; margin: 1px 0; }
    .info-text { font-size: 20pt; margin-top: 1px; white-space: pre-line; text-align: center; font-weight: 800; position: relative; z-index: 2;}
    .current-temp { font-weight: 800; font-size: 40pt; vertical-align: middle; }
    .weather-icon { font-size: 40pt; display: inline-block; vertical-align: middle; margin-left: 8px; }
    .temp-cold { color: #00f; }
    .temp-cool { color: #00ffff; }
    .temp-warm { color: #ffff00; }
    .temp-hot { color: #ff0000; }
    .large-time { font-size: 56pt; font-weight: 800; color: #ff9100; }
    .small-date { font-size: 40pt; font-weight: normal; color: #ffffff; }
    #weather-container { display: flex; justify-content: center; width: 80%; gap: 40px; }
    .weather { white-space: pre-line; text-align: center; margin: 8px; padding: 12px; border-radius: 12px; }
    #time-display-container { display: flex; justify-content: center; width: 80%; gap: 40px; }
    .time-display-column { text-align: center; line-height: 1; vertical-align: middle; }
    .daynight-icon { font-size: 32pt; vertical-align: middle; margin-left: 4px; line-height: 1; }
    #divider { width: 1px; background-color: white; opacity: 0.3; margin: 0 20px; height: auto; align-self: stretch; }
    #kitty-status, #kiki-status { font-size: 16pt; color: #ffffff; margin-top: 4px; text-align: center; font-weight: 800; }
    #bangkok-container, #toronto-container { display: flex; flex-direction: column; width: 50%; gap: 10px; }
    #main-weather-time-container { display: flex; justify-content: center; width: 80%; gap: 0; align-items: stretch; }
    @media (max-width: 500px) {
      html, body { height: auto; }
      #catGif { margin: 0 auto 10px auto; }
      #price { font-size: 80pt; white-space: normal; }
      #toggle-price-btn { top: 10px; right: 10px; font-size: 16pt; }
      #main-weather-time-container { flex-direction: column; width: 95%; gap: 20px; }
      #bangkok-container, #toronto-container { width: 100%; }
      #countdown { margin-top: 30px; font-size: 14pt; }
      body { align-items: stretch; }
      #divider { display: none; }
    }
  </style>
</head>
<body>
  <!-- Cat GIF displayed above price -->
  <img id="catGif" src="" alt="Cat GIF" />

  <button id="toggle-price-btn">üëÅÔ∏è</button>
  <div id="price">--</div>
  <div id="timestamp" class="info-text">Fetching...</div>
  <hr />
  <div id="main-weather-time-container">
    <div id="bangkok-container">
      <div class="weather info-text" id="weather-bkk">Loading Bangkok weather...</div>
      <div id="bangkok-time" class="time-display-column info-text">Loading Bangkok time...</div>
      <div id="kitty-status">Kitty is ...</div>
    </div>
    <div id="divider"></div>
    <div id="toronto-container">
      <div class="weather info-text" id="weather-toronto">Loading Toronto weather...</div>
      <div id="toronto-time" class="time-display-column info-text">Loading Toronto time...</div>
      <div id="kiki-status">Kiki is ...</div>
    </div>
  </div>
  <div id="countdown"></div>
  <script>
    function getFormattedTime(dateObj) {
      const d = String(dateObj.getDate()).padStart(2,'0'),
            m = String(dateObj.getMonth()+1).padStart(2,'0'),
            y = dateObj.getFullYear(),
            h = String(dateObj.getHours()).padStart(2,'0'),
            min = String(dateObj.getMinutes()).padStart(2,'0'),
            s = String(dateObj.getSeconds()).padStart(2,'0');
      return `${d}/${m}/${y} ${h}:${min}:${s}`;
    }
    function getTempClass(temp) {
      if (temp <= 0) return 'temp-cold';
      if (temp <= 15) return 'temp-cool';
      if (temp <= 25) return 'temp-warm';
      return 'temp-hot';
    }
    function getWeatherIcon(code) {
      const map = {
        0: "‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",
        45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",53:"üåßÔ∏è",55:"üåßÔ∏è",
        61:"üå¶Ô∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",71:"üå®Ô∏è",73:"üå®Ô∏è",
        75:"‚ùÑÔ∏è",80:"üå¶Ô∏è",81:"üåßÔ∏è",82:"üåßÔ∏è",95:"‚õàÔ∏è",96:"üå©Ô∏è",99:"üå©Ô∏è"
      };
      return map[code] || "‚ùì";
    }

    // GIPHY CAT GIF Fetch - Now fetching funny cat GIFs
    const giphyApiKey = 'kcagipE09dK95PCk7F5cL06I9BnT4bEm';
    async function fetchCatGif() {
      try {
        const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${giphyApiKey}&q=funny+cat&limit=25&rating=g`);
        const json = await res.json();
        if(json.data && json.data.length > 0) {
          // Pick random gif from the results
          const randIndex = Math.floor(Math.random() * json.data.length);
          const gifUrl = json.data[randIndex].images.fixed_width.url; // approx 200px width
          document.getElementById('catGif').src = gifUrl;
        }
      } catch(e) {
        console.error('Failed to fetch cat GIF', e);
      }
    }

    async function fetchPrice() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await res.json();
        const priceElem = document.getElementById('price');
        const newPrice = Math.round(parseFloat(data.price));
        // Animate price if changed
        if (priceElem.textContent !== newPrice.toString()) {
          priceElem.style.transform = 'scale(1.2)';
          setTimeout(() => {
            priceElem.style.transform = 'scale(1)';
          }, 500);
          // Fetch new cat gif only when price changes
          fetchCatGif();
        }
        priceElem.textContent = newPrice;
        document.getElementById('timestamp').textContent = `Updated: ${getFormattedTime(new Date())}`;
      } catch {
        document.getElementById('price').textContent = 'Error';
        document.getElementById('timestamp').textContent = 'Failed to fetch price';
      }
    }

    async function fetchAQI(cityName) {
      const cityMap = { "Bangkok": "bangkok", "Toronto": "toronto" };
      const cityKey = cityMap[cityName];
      if (!cityKey) return null;
      try {
        const url = `https://api.waqi.info/feed/${cityKey}/?token=34c4d3884fe7f730070458872adb4dfdb1e636e3`;
        const res = await fetch(url);
        const json = await res.json();
        return json.status === "ok" ? json.data.aqi : null;
      } catch {
        return null;
      }
    }

    async function fetchWeather(city, lat, lon, elementId, flagEmoji) {
      try {
        const res = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=auto`
        );
        const d = await res.json();
        const t = Math.round(d.current.temperature_2m);
        const code = d.current.weather_code;
        const mn = Math.round(d.daily.temperature_2m_min[0]);
        const mx = Math.round(d.daily.temperature_2m_max[0]);
        const icon = getWeatherIcon(code);
        const cls = getTempClass(t);
        const aqi = await fetchAQI(city);
        const aqiText = aqi !== null ? ` (AQI: ${aqi})` : "";
        document.getElementById(elementId).innerHTML =
          `${flagEmoji} ${city}:<br>` +
          `<span class="current-temp ${cls}">${t}¬∞C</span>` +
          `<span class="weather-icon">${icon}</span><br>` +
          `L:${mn}¬∞/H:${mx}¬∞${aqiText}`;
      } catch (e) {
        console.error(e);
        document.getElementById(elementId).textContent = `${flagEmoji} ${city} Weather: Failed to fetch`;
      }
    }

    function cacheCityTime(cityKey, timeZone) {
      const now = new Date(), nowUtcMs = now.getTime();
      const local = new Date(now.toLocaleString('en-US',{ timeZone }));
      localStorage.setItem(`${cityKey}_baseUtcMs`, nowUtcMs);
      localStorage.setItem(`${cityKey}_baseLocalMs`, local.getTime());
      localStorage.setItem(`${cityKey}_timeZone`, timeZone);
    }

    function getCityTimeFromCache(cityKey) {
      const bU = Number(localStorage.getItem(`${cityKey}_baseUtcMs`)),
            bL = Number(localStorage.getItem(`${cityKey}_baseLocalMs`));
      if (!bU || !bL) return null;
      return new Date(bL + (Date.now() - bU));
    }

    function displayCityTime(id, dt) {
      const optsD = { weekday:'short', day:'2-digit', month:'2-digit'};
      const optsT = { hour:'2-digit', minute:'2-digit', hour12: false };
      const date = dt.toLocaleDateString('en-GB', optsD).toUpperCase().replace(',', '');
      const time = dt.toLocaleTimeString('en-GB', optsT);
      const hr = dt.getHours(), ic = (hr>=7 && hr<19)? 'üåû':'üåô';
      document.getElementById(id).innerHTML =
        `<span class="small-date">${date}</span> ` +
        `<span class="large-time">${time}<span class="daynight-icon">${ic}</span></span>`;
    }

    function updateKittyStatus() {
      const now = getCityTimeFromCache('bangkok'); if (!now) return;
      const d= now.getDay(), m = now.getHours()*60 + now.getMinutes();
      let s='unknown';
      if (d>=1 && d<=5) {
        s = m<=540 ? 'sleeping üò¥' :
            m<=600 ? 'going to work üö∂‚Äç‚ôÄÔ∏è' :
            m<=780 ? 'working üíª' :
            m<=840 ? 'having a lunch break üçú' :
            m<=1170 ? 'working üíª' :
            m<=1230 ? 'going back home üè°' :
            m<=1290 ? 'decompressing üßò‚Äç‚ôÄÔ∏è' :
            m<=1350 ? 'watching News, YouTube üì∫' :
            m<=1380 ? 'doing stretching exercise üí™' : 'sleeping üò¥';
      } else {
        s = m <= 540 ? 'sleeping üò¥' : 'having a weekend! ü•≥';
      }
      document.getElementById("kitty-status").textContent = `Kitty is ${s}`;
    }

    function updateKikiStatus() {
      const now = getCityTimeFromCache('toronto'); if (!now) return;
      const d= now.getDay(), m= now.getHours()*60 + now.getMinutes();
      let s='unknown';
      if (d===0 || d===6) {
        s = m<=540 ? 'sleeping üò¥' : 'having a weekend üéâ';
      } else if ([1,3,5].includes(d)) {
        s = m<=420? 'sleeping üò¥' :
            m<=540? 'preparing for WFH üíª‚òï' :
            m<=1080? 'WFH üè†‚ú®' :
            m<=1380? 'relaxing üì∫üíñ' : 'sleeping üò¥';
      } else {
        s = m<=420? 'sleeping üò¥' :
            m<=539? 'going to the office üöóüí®' :
            m<=1080? 'working at the office üè¢üíº' :
            m<=1170? 'going back home üè°üíñ' :
            m<=1380? 'relaxing üõãÔ∏èüòä' : 'sleeping üò¥';
      }
      document.getElementById("kiki-status").textContent = `Kiki is ${s}`;
    }

    function updateCountdown() {
      const today = new Date(), end = new Date("2025-12-31T00:00:00");
      const days = Math.ceil((end - today) / (1000*60*60*24));
      document.getElementById("countdown").textContent = `${days} days to Kiki and Kitty Japan Trip`;
    }

    document.getElementById("toggle-price-btn").addEventListener("click", () => {
      document.getElementById('price').classList.toggle('hidden');
      document.getElementById('timestamp').classList.toggle('hidden');
    });

    // INITIAL
    fetchPrice();
    fetchWeather("Bangkok", 13.7563, 100.5018, "weather-bkk", "üáπüá≠");
    fetchWeather("Toronto", 43.65107, -79.347015, "weather-toronto", "üá®üá¶");
    updateCountdown();
    cacheCityTime('bangkok', 'Asia/Bangkok');
    cacheCityTime('toronto', 'America/Toronto');
    fetchCatGif();

    function displayCityTimes() {
      const b = getCityTimeFromCache('bangkok') || new Date(),
            t = getCityTimeFromCache('toronto') || new Date();
      displayCityTime('bangkok-time', b);
      displayCityTime('toronto-time', t);
    }
    displayCityTimes();
    updateKittyStatus(); updateKikiStatus();

    setInterval(fetchPrice, 5000);
    setInterval(() => {
      fetchWeather("Bangkok", 13.7563, 100.5018, "weather-bkk", "üáπüá≠");
      fetchWeather("Toronto", 43.65107, -79.347015, "weather-toronto", "üá®üá¶");
      updateKittyStatus(); updateKikiStatus();
      cacheCityTime('bangkok', 'Asia/Bangkok');
      cacheCityTime('toronto', 'America/Toronto');
    }, 600000);

    setInterval(() => {
      displayCityTimes();
      updateKittyStatus(); updateKikiStatus();
    }, 1000);
  </script>
</body>
</html>
